import csv
import os
from itertools import product

import geopandas as gpd
import autocensus

census_key = os.getenv("US_CENSUS_KEY")

# Get 2018 census data
# For reference https://api.census.gov/data/2018/acs/acs5/subject/variables.html
# Use population change in different age groups as proxy for "vulnerability"
tables = ['S0101_C01']
vars = []
for table, col, vtype in product(tables, range(1, 20), ['E', 'M']):
    vars.append(f'{table}_{col:03}{vtype}')

vars += ['UA', 'DP04_0079E', 'DP04_0079M',
         'DP04_0001E', 'DP04_0001M', 'DP05_0002E', 'DP05_0002M',
         'DP03_0102E', 'DP03_0102M', 'DP03_0043E', 'DP03_0043M',
         'DP03_0046E', 'DP03_0046M', 'DP03_0001E', 'DP03_0001M',
         'DP05_0039E', 'DP05_0039M', 'DP02_0036PE', 'DP02_0036PM',
         ]
print(vars)

query = autocensus.Query(
    estimate=5,
    years=[2014, 2018],
    variables=vars,
    # For the location code: https://www.census.gov/library/reference/code-lists/ansi.html
    for_geo=['tract:*'],
    in_geo=['state:06', 'county:*'], # California
    geometry='polygons',
    census_api_key=census_key
)
df = query.run()

gdf = gpd.GeoDataFrame(df, geometry='geometry')
gdf.drop(columns=['geo_type', 'date', 'variable_concept',
                  'annotation', 'variable_code', 'name', 'geometry'],
         inplace=True)
gdf.shape
gdf.columns
gdf.iloc[0]

gdf['est_or_err'] = gdf.variable_label.apply(lambda x: 'M' if x.find('Margin of Error') > -1 else 'E')
gdf['category'] = gdf.variable_label.apply(lambda x: x.split('!!')[-1])
young = gdf.category.isin(["20 to 24 years", "25 to 34 years",
                           "35 to 44 years", "45 to 54 years"])
gdf = gdf.loc[young]
gdf.drop(columns=['variable_label'], inplace=True)
gdf.iloc[0]
pdf = gdf.pivot(index=["geo_id"],
                columns=["est_or_err", "year", "category"],
                values="value").reset_index()
pdf.iloc[0]


# California Social Vulnerability Index
gpd14 = gpd.read_file('svi_ca_2014/CALIFORNIA.shp')
svi = gpd14[["AFFGEOID", "RPL_THEME1", "RPL_THEME2",
             "RPL_THEME3", "RPL_THEME3", "RPL_THEMES"]]
svi.shape
# gpd18 = gpd.read_file('svi_ca_2018/SVI2018_CALIFORNIA_tract.shp')
# gpd18.drop(columns=['ST', 'STATE', 'ST_ABBR', 'STCNTY'], inplace=True)


jdf = pdf.merge(svi, left_on='geo_id', right_on='AFFGEOID', how='outer')
jdf.shape
svi.shape
pdf.shape
jdf.columns
jdf.sample(3)

jdf.to_csv("svi_census.csv", index=False, quoting=csv.QUOTE_NONNUMERIC)